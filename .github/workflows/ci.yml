name: Build All Platforms

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows (VST3, Standalone)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v6

      - name: Configure
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build VST3
        run: cmake --build build --target VizBeats_VST3 --parallel

      - name: Build Standalone
        run: cmake --build build --target VizBeatsStandalone --parallel

      - name: Prepare Windows artifacts
        run: |
          mkdir -p artifacts/Windows
          cp -r build/VizBeats_artefacts/Release/VST3/VizBeats.vst3 artifacts/Windows/
          cp build/VizBeatsStandalone_artefacts/Release/VizBeatsStandalone.exe artifacts/Windows/
        shell: bash

      - name: Upload Windows VST3
        uses: actions/upload-artifact@v4
        with:
          name: VizBeats-Windows-VST3
          path: artifacts/Windows/VizBeats.vst3

      - name: Upload Windows Standalone
        uses: actions/upload-artifact@v4
        with:
          name: VizBeats-Windows-Standalone
          path: artifacts/Windows/VizBeatsStandalone.exe

  build-macos:
    name: macOS (VST3, AU, Standalone)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Universal Binary with Xcode)
        run: |
          cmake -S . -B build -G Xcode \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="10.13"

      - name: Build VST3
        run: cmake --build build --config Release --target VizBeats_VST3

      - name: Build AU
        run: cmake --build build --config Release --target VizBeats_AU

      - name: Build Standalone
        run: cmake --build build --config Release --target VizBeatsStandalone

      - name: Verify build output
        run: |
          echo "Checking build artifacts..."
          ls -la build/VizBeatsStandalone_artefacts/Release/ || true
          ls -la build/VizBeats_artefacts/Release/ || true
          echo "Checking architectures..."
          file build/VizBeatsStandalone_artefacts/Release/VizBeatsStandalone.app/Contents/MacOS/VizBeatsStandalone || true
          file build/VizBeats_artefacts/Release/AU/VizBeats.component/Contents/MacOS/VizBeats || true

      - name: Ad-hoc sign binaries
        run: |
          codesign --force --deep --sign - build/VizBeatsStandalone_artefacts/Release/VizBeatsStandalone.app
          codesign --force --deep --sign - build/VizBeats_artefacts/Release/VST3/VizBeats.vst3
          codesign --force --deep --sign - build/VizBeats_artefacts/Release/AU/VizBeats.component

      - name: Validate AU for Logic Pro
        run: |
          # Copy AU to system location for validation
          sudo mkdir -p /Library/Audio/Plug-Ins/Components
          sudo cp -r build/VizBeats_artefacts/Release/AU/VizBeats.component /Library/Audio/Plug-Ins/Components/
          sudo xattr -cr /Library/Audio/Plug-Ins/Components/VizBeats.component

          # Run AU validation (auval)
          echo "Running AU validation..."
          auval -v aufx Vzbp VzBt 2>&1 || echo "AU validation completed"

          # Clean up
          sudo rm -rf /Library/Audio/Plug-Ins/Components/VizBeats.component

      - name: Create macOS PKG installers
        run: |
          # Create staging directories
          mkdir -p pkg-standalone/payload/Applications
          mkdir -p pkg-vst3/payload/Library/Audio/Plug-Ins/VST3
          mkdir -p pkg-au/payload/Library/Audio/Plug-Ins/Components
          mkdir -p pkg-scripts

          # Remove quarantine and copy binaries
          xattr -cr build/VizBeatsStandalone_artefacts/Release/VizBeatsStandalone.app
          xattr -cr build/VizBeats_artefacts/Release/VST3/VizBeats.vst3
          xattr -cr build/VizBeats_artefacts/Release/AU/VizBeats.component

          cp -r build/VizBeatsStandalone_artefacts/Release/VizBeatsStandalone.app pkg-standalone/payload/Applications/
          cp -r build/VizBeats_artefacts/Release/VST3/VizBeats.vst3 pkg-vst3/payload/Library/Audio/Plug-Ins/VST3/
          cp -r build/VizBeats_artefacts/Release/AU/VizBeats.component pkg-au/payload/Library/Audio/Plug-Ins/Components/

          # Create postinstall script for AU (resets Logic cache)
          cat > pkg-scripts/postinstall << 'SCRIPT'
          #!/bin/bash
          xattr -cr "/Library/Audio/Plug-Ins/Components/VizBeats.component"
          killall -9 AudioComponentRegistrar 2>/dev/null || true
          rm -rf ~/Library/Caches/AudioUnitCache 2>/dev/null || true
          rm -rf ~/Library/Caches/com.apple.audiounits.cache 2>/dev/null || true
          exit 0
          SCRIPT
          chmod +x pkg-scripts/postinstall

          # Create postinstall for VST3
          cat > pkg-scripts/postinstall-vst3 << 'SCRIPT'
          #!/bin/bash
          xattr -cr "/Library/Audio/Plug-Ins/VST3/VizBeats.vst3"
          exit 0
          SCRIPT
          chmod +x pkg-scripts/postinstall-vst3

          # Create postinstall for Standalone
          cat > pkg-scripts/postinstall-standalone << 'SCRIPT'
          #!/bin/bash
          xattr -cr "/Applications/VizBeatsStandalone.app"
          exit 0
          SCRIPT
          chmod +x pkg-scripts/postinstall-standalone

          mkdir -p artifacts

          # Build Standalone PKG
          mkdir -p pkg-standalone-scripts
          cp pkg-scripts/postinstall-standalone pkg-standalone-scripts/postinstall
          pkgbuild --root pkg-standalone/payload \
                   --scripts pkg-standalone-scripts \
                   --identifier com.vizbeats.standalone \
                   --version 1.0.0 \
                   --install-location / \
                   artifacts/VizBeats-macOS-Standalone.pkg

          # Build VST3 PKG
          mkdir -p pkg-vst3-scripts
          cp pkg-scripts/postinstall-vst3 pkg-vst3-scripts/postinstall
          pkgbuild --root pkg-vst3/payload \
                   --scripts pkg-vst3-scripts \
                   --identifier com.vizbeats.vst3 \
                   --version 1.0.0 \
                   --install-location / \
                   artifacts/VizBeats-macOS-VST3.pkg

          # Build AU PKG
          pkgbuild --root pkg-au/payload \
                   --scripts pkg-scripts \
                   --identifier com.vizbeats.au \
                   --version 1.0.0 \
                   --install-location / \
                   artifacts/VizBeats-macOS-AU.pkg

      - name: Upload macOS Standalone PKG
        uses: actions/upload-artifact@v4
        with:
          name: VizBeats-macOS-Standalone
          path: artifacts/VizBeats-macOS-Standalone.pkg

      - name: Upload macOS VST3 PKG
        uses: actions/upload-artifact@v4
        with:
          name: VizBeats-macOS-VST3
          path: artifacts/VizBeats-macOS-VST3.pkg

      - name: Upload macOS AU PKG
        uses: actions/upload-artifact@v4
        with:
          name: VizBeats-macOS-AU
          path: artifacts/VizBeats-macOS-AU.pkg

  release:
    name: Create Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Windows ZIP
        run: |
          cd artifacts
          zip -r VizBeats-Windows.zip VizBeats-Windows-VST3 VizBeats-Windows-Standalone

      - name: Prepare release files
        run: |
          mkdir release
          cp artifacts/VizBeats-Windows.zip release/
          cp artifacts/VizBeats-macOS-Standalone/VizBeats-macOS-Standalone.pkg release/
          cp artifacts/VizBeats-macOS-VST3/VizBeats-macOS-VST3.pkg release/
          cp artifacts/VizBeats-macOS-AU/VizBeats-macOS-AU.pkg release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/VizBeats-Windows.zip
            release/VizBeats-macOS-Standalone.pkg
            release/VizBeats-macOS-VST3.pkg
            release/VizBeats-macOS-AU.pkg
          body: |
            ## VizBeats Release

            ### Windows
            - **VizBeats-Windows.zip** - Extract and run `VizBeatsStandalone.exe` or copy `VizBeats.vst3` to your VST3 folder

            ### macOS (Universal Binary - Intel + Apple Silicon)
            - **VizBeats-macOS-Standalone.pkg** - Standalone application installer
            - **VizBeats-macOS-VST3.pkg** - VST3 plugin installer (for Ableton, FL Studio, etc.)
            - **VizBeats-macOS-AU.pkg** - Audio Unit plugin installer (for Logic Pro, GarageBand)

            #### macOS Installation
            1. Download the .pkg file for your format
            2. Double-click to open the installer
            3. If you see "unidentified developer" warning, right-click the .pkg and select "Open"
            4. Follow the installer prompts
            5. Restart your DAW

            The installer automatically handles all security settings and plugin registration.
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
